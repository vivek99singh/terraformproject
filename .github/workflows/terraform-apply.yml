name: Terraform Apply Workflow

on:
  push:
    branches:
      - main
    paths:
      - 'terraform/**'
      - '.github/workflows/terraform-apply.yml'

permissions:
  contents: read
  pull-requests: write
  id-token: write

env:
  TF_VERSION: '1.6.0'
  TERRAFORM_DIR: './terraform'

jobs:
  terraform-apply:
    name: Apply Terraform Changes
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://portal.azure.com
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: |
            {
              "clientId": "${{ secrets.AZURE_CLIENT_ID }}",
              "clientSecret": "${{ secrets.AZURE_CLIENT_SECRET }}",
              "subscriptionId": "${{ secrets.AZURE_SUBSCRIPTION_ID }}",
              "tenantId": "${{ secrets.AZURE_TENANT_ID }}"
            }

      - name: Check Backend State
        id: check-state
        run: |
          echo "Checking if state file exists in backend..."
          
          # Get storage account key
          ACCOUNT_KEY=$(az storage account keys list \
            --resource-group "${{ secrets.TF_STATE_RESOURCE_GROUP }}" \
            --account-name "${{ secrets.TF_STATE_STORAGE_ACCOUNT }}" \
            --query '[0].value' -o tsv)
          
          # Check if state file exists
          if az storage blob exists \
            --container-name "${{ secrets.TF_STATE_CONTAINER }}" \
            --name "terraform.tfstate" \
            --account-name "${{ secrets.TF_STATE_STORAGE_ACCOUNT }}" \
            --account-key "$ACCOUNT_KEY" \
            --query "exists" -o tsv | grep -q "true"; then
            echo "state_exists=true" >> $GITHUB_OUTPUT
            echo "âœ… State file exists - will use existing state"
            
            # Download and show resources in state
            az storage blob download \
              --container-name "${{ secrets.TF_STATE_CONTAINER }}" \
              --name "terraform.tfstate" \
              --file "state-check.json" \
              --account-name "${{ secrets.TF_STATE_STORAGE_ACCOUNT }}" \
              --account-key "$ACCOUNT_KEY" \
              --output none
            
            echo "Resources in existing state:"
            jq -r '.resources[] | "  - \(.type).\(.name)"' state-check.json || echo "  (unable to parse state)"
          else
            echo "state_exists=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No existing state file - this is a new deployment"
          fi
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

      - name: Terraform Init
        id: init
        run: |
          echo "Initializing Terraform..."
          terraform init -reconfigure
          
          echo "Backend initialized successfully"
        working-directory: ${{ env.TERRAFORM_DIR }}
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      
      - name: Show Current State
        run: |
          echo "Current resources in Terraform state:"
          terraform state list || echo "No resources in state yet"
        working-directory: ${{ env.TERRAFORM_DIR }}
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

      - name: Import Existing Resources
        id: import
        run: |
          echo "ðŸ” Checking for existing Azure resources that need to be imported..."
          echo ""
          
          # Function to safely import a resource
          import_resource() {
            local resource_address=$1
            local resource_id=$2
            
            echo "Checking: $resource_address"
            
            # Check if resource is already in state
            if terraform state show "$resource_address" &> /dev/null; then
              echo "  âœ… Already in state - skipping"
              return 0
            fi
            
            # Check if resource exists in Azure
            if az resource show --ids "$resource_id" &> /dev/null; then
              echo "  ðŸ“¥ Found in Azure - importing..."
              if terraform import "$resource_address" "$resource_id" 2>&1; then
                echo "  âœ… Successfully imported"
                return 0
              else
                echo "  âš ï¸ Import failed - will try to create"
                return 1
              fi
            else
              echo "  â„¹ï¸ Does not exist in Azure - will be created"
              return 0
            fi
          }
          
          echo "1ï¸âƒ£ Importing Resource Group..."
          import_resource "azurerm_resource_group.main" \
            "/subscriptions/${{ secrets.AZURE_SUBSCRIPTION_ID }}/resourceGroups/rg-windows-vm"
          echo ""
          
          echo "2ï¸âƒ£ Importing Storage Accounts..."
          STORAGE_ACCOUNTS=$(az storage account list --resource-group rg-windows-vm --query "[?starts_with(name, 'bootdiag')].name" -o tsv 2>/dev/null || echo "")
          if [ -n "$STORAGE_ACCOUNTS" ]; then
            for sa in $STORAGE_ACCOUNTS; do
              echo "Found storage account: $sa"
              import_resource "azurerm_storage_account.bootdiag" \
                "/subscriptions/${{ secrets.AZURE_SUBSCRIPTION_ID }}/resourceGroups/rg-windows-vm/providers/Microsoft.Storage/storageAccounts/$sa"
              break  # Only import the first one
            done
          else
            echo "  â„¹ï¸ No bootdiag storage accounts found"
          fi
          echo ""
          
          echo "3ï¸âƒ£ Importing Network Resources..."
          VNETS=$(az network vnet list --resource-group rg-windows-vm --query "[].name" -o tsv 2>/dev/null || echo "")
          if [ -n "$VNETS" ]; then
            for vnet in $VNETS; do
              echo "Found VNet: $vnet"
              import_resource "module.network.azurerm_virtual_network.main" \
                "/subscriptions/${{ secrets.AZURE_SUBSCRIPTION_ID }}/resourceGroups/rg-windows-vm/providers/Microsoft.Network/virtualNetworks/$vnet"
              
              # Import subnets
              SUBNETS=$(az network vnet subnet list --resource-group rg-windows-vm --vnet-name $vnet --query "[].name" -o tsv 2>/dev/null || echo "")
              if [ -n "$SUBNETS" ]; then
                subnet_index=0
                for subnet in $SUBNETS; do
                  echo "Found Subnet: $subnet"
                  import_resource "module.network.azurerm_subnet.main[\"$subnet_index\"]" \
                    "/subscriptions/${{ secrets.AZURE_SUBSCRIPTION_ID }}/resourceGroups/rg-windows-vm/providers/Microsoft.Network/virtualNetworks/$vnet/subnets/$subnet"
                  subnet_index=$((subnet_index + 1))
                done
              fi
              break
            done
          else
            echo "  â„¹ï¸ No VNets found"
          fi
          echo ""
          
          echo "4ï¸âƒ£ Importing NSG..."
          NSGS=$(az network nsg list --resource-group rg-windows-vm --query "[].name" -o tsv 2>/dev/null || echo "")
          if [ -n "$NSGS" ]; then
            for nsg in $NSGS; do
              echo "Found NSG: $nsg"
              import_resource "module.network.azurerm_network_security_group.main" \
                "/subscriptions/${{ secrets.AZURE_SUBSCRIPTION_ID }}/resourceGroups/rg-windows-vm/providers/Microsoft.Network/networkSecurityGroups/$nsg"
              break
            done
          else
            echo "  â„¹ï¸ No NSGs found"
          fi
          echo ""
          
          echo "5ï¸âƒ£ Importing Public IP..."
          PUBLIC_IPS=$(az network public-ip list --resource-group rg-windows-vm --query "[].name" -o tsv 2>/dev/null || echo "")
          if [ -n "$PUBLIC_IPS" ]; then
            for pip in $PUBLIC_IPS; do
              echo "Found Public IP: $pip"
              import_resource "module.network.azurerm_public_ip.main" \
                "/subscriptions/${{ secrets.AZURE_SUBSCRIPTION_ID }}/resourceGroups/rg-windows-vm/providers/Microsoft.Network/publicIPAddresses/$pip"
              break
            done
          else
            echo "  â„¹ï¸ No Public IPs found"
          fi
          echo ""
          
          echo "6ï¸âƒ£ Importing Network Interface..."
          NICS=$(az network nic list --resource-group rg-windows-vm --query "[].name" -o tsv 2>/dev/null || echo "")
          if [ -n "$NICS" ]; then
            for nic in $NICS; do
              echo "Found NIC: $nic"
              import_resource "module.vm.azurerm_network_interface.main" \
                "/subscriptions/${{ secrets.AZURE_SUBSCRIPTION_ID }}/resourceGroups/rg-windows-vm/providers/Microsoft.Network/networkInterfaces/$nic"
              break
            done
          else
            echo "  â„¹ï¸ No NICs found"
          fi
          echo ""
          
          echo "7ï¸âƒ£ Importing Virtual Machine..."
          VMS=$(az vm list --resource-group rg-windows-vm --query "[].name" -o tsv 2>/dev/null || echo "")
          if [ -n "$VMS" ]; then
            for vm in $VMS; do
              echo "Found VM: $vm"
              import_resource "module.vm.azurerm_windows_virtual_machine.main" \
                "/subscriptions/${{ secrets.AZURE_SUBSCRIPTION_ID }}/resourceGroups/rg-windows-vm/providers/Microsoft.Compute/virtualMachines/$vm"
              break
            done
          else
            echo "  â„¹ï¸ No VMs found"
          fi
          echo ""
          
          echo "8ï¸âƒ£ Importing Managed Disks..."
          DISKS=$(az disk list --resource-group rg-windows-vm --query "[?name!=''].name" -o tsv 2>/dev/null || echo "")
          if [ -n "$DISKS" ]; then
            for disk in $DISKS; do
              # Skip OS disks
              if [[ $disk == *"OsDisk"* ]] || [[ $disk == *"osdisk"* ]]; then
                echo "Skipping OS disk: $disk"
                continue
              fi
              echo "Found Data Disk: $disk"
              import_resource "module.vm.azurerm_managed_disk.data" \
                "/subscriptions/${{ secrets.AZURE_SUBSCRIPTION_ID }}/resourceGroups/rg-windows-vm/providers/Microsoft.Compute/disks/$disk"
            done
          else
            echo "  â„¹ï¸ No managed disks found"
          fi
          echo ""
          
          echo "âœ… Import process complete!"
          echo ""
          echo "ðŸ“Š Final state:"
          terraform state list || echo "No resources in state"
        working-directory: ${{ env.TERRAFORM_DIR }}
        continue-on-error: false
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

      - name: Terraform Plan
        id: plan
        run: terraform plan -out=tfplan -no-color
        working-directory: ${{ env.TERRAFORM_DIR }}
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

      - name: Terraform Apply
        id: apply
        run: terraform apply -auto-approve tfplan
        working-directory: ${{ env.TERRAFORM_DIR }}
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

      - name: Terraform Output
        id: output
        run: terraform output -json > outputs.json
        working-directory: ${{ env.TERRAFORM_DIR }}
        continue-on-error: true
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

      - name: Upload Terraform Outputs
        uses: actions/upload-artifact@v4
        if: steps.output.outcome == 'success'
        with:
          name: terraform-outputs
          path: ${{ env.TERRAFORM_DIR }}/outputs.json

# Made with Bob
